var d;(function(e){e[e.FreePoint=0]="FreePoint",e[e.ControlPoint=1]="ControlPoint"})(d||(d={}));var S=class{constructor(t){this.maxDrawBufferSize=2048,this._canvasDom=document.querySelector(t),this._context=this._canvasDom.getContext("2d"),this.AutoSetCanvasSize(),window.addEventListener("resize",()=>{this.AutoSetCanvasSize()})}get canvasDom(){return this._canvasDom}Draw(t){this._context.clearRect(0,0,this._canvasDom.width,this._canvasDom.height);let i=t.length;for(let n=0;n<i;n++){let r=t[n].type==d.ControlPoint?"59, 50, 255":"255,165,0";this.DrawCircle(t[n].position[0],t[n].position[1],7,r)}}DrawCircle(t,i,n,r){this._context.beginPath(),this._context.fillStyle=`rgb(${r})`,this._context.arc(t,i,n,0,2*Math.PI),this._context.fill()}AutoSetCanvasSize(){this.SetCanvasToSceenSize(this._canvasDom.clientWidth,this._canvasDom.clientHeight)}SetCanvasToSceenSize(t,i){(t>this.maxDrawBufferSize||i>this.maxDrawBufferSize)&&(i=i>t?this.maxDrawBufferSize:this.maxDrawBufferSize*i/t,t=t>=i?this.maxDrawBufferSize:this.maxDrawBufferSize*t/i),this._canvasDom.width=t,this._canvasDom.height=i}},b=S;var w=class{get nodeLength(){return this._nodes.length}get nodes(){return this._nodes}constructor(t,i,n,r){this._segmentNumber=n,this._segmentDistance=r,this._nodes=[];for(let o=0;o<n-1;o++)this.PushNode()}PushNode(){if(this.nodeLength<=0)return;let t=this._nodes[this.nodeLength-1],i=t.position[0],n=t.position[1];return null}PopNode(){if(!(this.nodeLength<=0))return this._segmentNumber--,this._nodes.pop()}Update(){let t=this._nodes.length;for(let i=0;i<t;i++){if(this._nodes[i].isStatic)continue;let n=i>0?this._nodes[i-1]:null;this._nodes[i].UpdateForce(n)}}},P=w;var F=1e-6,v=typeof Float32Array!="undefined"?Float32Array:Array,X=Math.random;Math.hypot||(Math.hypot=function(){for(var e=0,t=arguments.length;t--;)e+=arguments[t]*arguments[t];return Math.sqrt(e)});function I(){var e=new v(2);return v!=Float32Array&&(e[0]=0,e[1]=0),e}function G(e){var t=new v(2);return t[0]=e[0],t[1]=e[1],t}function H(e,t){var i=new v(2);return i[0]=e,i[1]=t,i}function Q(e,t){return e[0]=t[0],e[1]=t[1],e}function $(e,t,i){return e[0]=t,e[1]=i,e}function J(e,t,i){return e[0]=t[0]+i[0],e[1]=t[1]+i[1],e}function E(e,t,i){return e[0]=t[0]-i[0],e[1]=t[1]-i[1],e}function T(e,t,i){return e[0]=t[0]*i[0],e[1]=t[1]*i[1],e}function U(e,t,i){return e[0]=t[0]/i[0],e[1]=t[1]/i[1],e}function Z(e,t){return e[0]=Math.ceil(t[0]),e[1]=Math.ceil(t[1]),e}function W(e,t){return e[0]=Math.floor(t[0]),e[1]=Math.floor(t[1]),e}function tt(e,t,i){return e[0]=Math.min(t[0],i[0]),e[1]=Math.min(t[1],i[1]),e}function et(e,t,i){return e[0]=Math.max(t[0],i[0]),e[1]=Math.max(t[1],i[1]),e}function it(e,t){return e[0]=Math.round(t[0]),e[1]=Math.round(t[1]),e}function nt(e,t,i){return e[0]=t[0]*i,e[1]=t[1]*i,e}function rt(e,t,i,n){return e[0]=t[0]+i[0]*n,e[1]=t[1]+i[1]*n,e}function j(e,t){var i=t[0]-e[0],n=t[1]-e[1];return Math.hypot(i,n)}function A(e,t){var i=t[0]-e[0],n=t[1]-e[1];return i*i+n*n}function K(e){var t=e[0],i=e[1];return Math.hypot(t,i)}function N(e){var t=e[0],i=e[1];return t*t+i*i}function st(e,t){return e[0]=-t[0],e[1]=-t[1],e}function ot(e,t){return e[0]=1/t[0],e[1]=1/t[1],e}function at(e,t){var i=t[0],n=t[1],r=i*i+n*n;return r>0&&(r=1/Math.sqrt(r)),e[0]=t[0]*r,e[1]=t[1]*r,e}function ht(e,t){return e[0]*t[0]+e[1]*t[1]}function lt(e,t,i){var n=t[0]*i[1]-t[1]*i[0];return e[0]=e[1]=0,e[2]=n,e}function ct(e,t,i,n){var r=t[0],o=t[1];return e[0]=r+n*(i[0]-r),e[1]=o+n*(i[1]-o),e}function dt(e,t){t=t||1;var i=X()*2*Math.PI;return e[0]=Math.cos(i)*t,e[1]=Math.sin(i)*t,e}function ut(e,t,i){var n=t[0],r=t[1];return e[0]=i[0]*n+i[2]*r,e[1]=i[1]*n+i[3]*r,e}function pt(e,t,i){var n=t[0],r=t[1];return e[0]=i[0]*n+i[2]*r+i[4],e[1]=i[1]*n+i[3]*r+i[5],e}function ft(e,t,i){var n=t[0],r=t[1];return e[0]=i[0]*n+i[3]*r+i[6],e[1]=i[1]*n+i[4]*r+i[7],e}function _t(e,t,i){var n=t[0],r=t[1];return e[0]=i[0]*n+i[4]*r+i[12],e[1]=i[1]*n+i[5]*r+i[13],e}function mt(e,t,i,n){var r=t[0]-i[0],o=t[1]-i[1],a=Math.sin(n),h=Math.cos(n);return e[0]=r*h-o*a+i[0],e[1]=r*a+o*h+i[1],e}function gt(e,t){var i=e[0],n=e[1],r=t[0],o=t[1],a=Math.sqrt(i*i+n*n)*Math.sqrt(r*r+o*o),h=a&&(i*r+n*o)/a;return Math.acos(Math.min(Math.max(h,-1),1))}function vt(e){return e[0]=0,e[1]=0,e}function yt(e){return"vec2("+e[0]+", "+e[1]+")"}function Mt(e,t){return e[0]===t[0]&&e[1]===t[1]}function St(e,t){var i=e[0],n=e[1],r=t[0],o=t[1];return Math.abs(i-r)<=F*Math.max(1,Math.abs(i),Math.abs(r))&&Math.abs(n-o)<=F*Math.max(1,Math.abs(n),Math.abs(o))}var wt=K,xt=E,Ct=T,Dt=U,kt=j,Lt=A,bt=N,Pt=function(){var e=I();return function(t,i,n,r,o,a){var h,l;for(i||(i=2),n||(n=0),r?l=Math.min(r*i+n,t.length):l=t.length,h=n;h<l;h+=i)e[0]=t[h],e[1]=t[h+1],o(e,e,a),t[h]=e[0],t[h+1]=e[1];return t}}(),s=Object.freeze({__proto__:null,create:I,clone:G,fromValues:H,copy:Q,set:$,add:J,subtract:E,multiply:T,divide:U,ceil:Z,floor:W,min:tt,max:et,round:it,scale:nt,scaleAndAdd:rt,distance:j,squaredDistance:A,length:K,squaredLength:N,negate:st,inverse:ot,normalize:at,dot:ht,cross:lt,lerp:ct,random:dt,transformMat2:ut,transformMat2d:pt,transformMat3:ft,transformMat4:_t,rotate:mt,angle:gt,zero:vt,str:yt,exactEquals:Mt,equals:St,len:wt,sub:xt,mul:Ct,div:Dt,dist:kt,sqrDist:Lt,sqrLen:bt,forEach:Pt});var c=Object.freeze({up:"up",down:"down",left:"left",right:"right"}),_=Object.create({w:c.up,s:c.down,d:c.right,a:c.left,ArrowUp:c.up,ArrowDown:c.down,ArrowRight:c.right,ArrowLeft:c.left});var y=Object.freeze({Up:s.fromValues(0,1),Down:s.fromValues(0,-1),Left:s.fromValues(-1,0),Right:s.fromValues(1,0),Center:s.fromValues(0,0)}),m;(function(e){e[e.Down=0]="Down",e[e.Up=1]="Up",e[e.Click=2]="Click"})(m||(m={}));var z=class{constructor(){this._buttonState=Object.create({}),this._cacheKeyboardDirection=s.create(),this.isMouseDown=!1}GetButtonState(t){return!1}RegisterButtonEvent(t){this._mouseClickCallback=t;let i=this;window.addEventListener("click",n=>{t(2)}),window.addEventListener("mousedown",n=>{t(0),this.isMouseDown=!0}),window.addEventListener("mouseup",n=>{this.isMouseDown=!1,t(1)})}RegisterMouseMovement(t,i){let n=[0,0],r=[0,0];window.addEventListener("mousemove",o=>{n[0]=o.movementX,n[1]=o.movementY,r[0]=o.offsetX,r[1]=o.offsetY,i(r,n)})}RegisterMovementEvent(t){let i=this;this._keyboardCallback=t,window.addEventListener("keydown",n=>{n.key.toLowerCase()in _&&this.SetKeyboardState(_[n.key],!0)}),window.addEventListener("keyup",n=>{n.key.toLowerCase()in _&&this.SetKeyboardState(_[n.key],!1)})}OnUpdate(){this._cacheKeyboardDirection[0]=0,this._cacheKeyboardDirection[1]=0,this._buttonState.hasOwnProperty(c.left)&&s.add(this._cacheKeyboardDirection,this._cacheKeyboardDirection,y.Left),this._buttonState.hasOwnProperty(c.down)&&s.add(this._cacheKeyboardDirection,this._cacheKeyboardDirection,y.Down),this._buttonState.hasOwnProperty(c.right)&&s.add(this._cacheKeyboardDirection,this._cacheKeyboardDirection,y.Right),this._buttonState.hasOwnProperty(c.up)&&s.add(this._cacheKeyboardDirection,this._cacheKeyboardDirection,y.Up),this.isMouseDown&&this._mouseClickCallback!=null&&this._mouseClickCallback(0),this._keyboardCallback!=null&&this._keyboardCallback(this._cacheKeyboardDirection)}SetKeyboardState(t,i){i?this._buttonState[t]=!0:delete this._buttonState[t]}},q=z;function g(e,t,i){return e+t*i}function M(e,t){let i=e<t?e:t,n=i==e?t:e;return i+"-"+n}var x=class{constructor(t,i,n,r,o,a){this.isStatic=!1,this._mass=5,this._k=7,this._gravity=10,this._timeStep=.02,this._damping=30,this._position=s.fromValues(t,i),this._type=a,this._velocity=s.fromValues(0,0),this._acceleration=s.fromValues(0,0),this._externalForce=s.fromValues(0,this._gravity),this._index=n,this._gridIndexX=r,this._gridIndexY=o,this.isStatic=a==d.ControlPoint}get type(){return this._type}get position(){return this._position}get index(){return this._index}UpdatePosition(t,i){this._position[0]=t,this._position[1]=i}UpdateForce(t){var i=s.create(),n=s.create(),r=s.create(),o=s.create();s.sub(i,this._position,t.position),s.scale(i,i,-this._k),s.scale(n,this._velocity,this._damping),s.sub(r,i,n),r[1]=r[1]+this._mass*this._gravity;let a=1/this._mass;s.scale(o,r,a),s.scale(o,o,this._timeStep),s.add(this._velocity,this._velocity,o),s.add(this._position,this._position,this._velocity)}UpdateVelocity(t,i){var n=s.create();this._acceleration=this.IntegrateForce(t,i),s.scale(n,this._velocity,this._damping),s.sub(this._acceleration,this._acceleration,n),this._externalForce=s.fromValues(0,this._gravity),s.scale(this._externalForce,this._externalForce,this._mass),s.add(this._acceleration,this._externalForce,this._acceleration);let r=1/this._mass;s.scale(this._acceleration,this._acceleration,r),s.scale(this._acceleration,this._acceleration,this._timeStep),s.add(this._velocity,this._velocity,this._acceleration),s.add(this._position,this._position,this._velocity)}IntegrateForce(t,i){return s.zero(this._acceleration),[[0,1],[1,0],[0,-1],[-1,0],[1,1],[1,-1],[-1,-1],[-1,1],[0,2],[2,0],[0,-2],[-2,0]].forEach(r=>{let o=this._gridIndexX+r[0],a=this._gridIndexY+r[1];if(o<t&&a<t&&o>=0&&a>=0){let h=g(o,a,t),l=M(this._index,h);if(l in i){let u=i[l],p=Math.floor(u.nodes[0].index)==Math.floor(this.index)?u.nodes[1]:u.nodes[0],f=this.CalSpringForce(this,p,this._k,u.restLength);s.add(this._acceleration,this._acceleration,f)}}}),this._acceleration}CalSpringForce(t,i,n,r){let o=s.fromValues(0,0),a=s.fromValues(0,0),h=s.sub(o,t.position,i.position);s.normalize(a,h),s.scale(a,a,r),s.add(a,i.position,a);let l=s.sub(a,t.position,a);return s.scale(o,l,-n)}},O=x;var C=class{get nodeLength(){return this._nodes.length}get nodes(){return this._nodes}constructor(t,i,n,r){this._width=t,this._height=t,this._subdivide=i,this._springNatureLength=t/i,this._nodes=this.CreateClothNodes(n,r,i,this._springNatureLength),this._springLinkLookupTable=this.GenerateSpringLink(),console.log(this._springLinkLookupTable)}Update(){let t=this._nodes.length;for(let i=0;i<t;i++)this._nodes[i].isStatic||this._nodes[i].UpdateVelocity(this._subdivide+1,this._springLinkLookupTable)}CreateClothNodes(t,i,n,r){let o=[];for(let a=0;a<=n;a++)for(let h=0;h<=n;h++){let l=a==0&&h==0||a==0&&h==n?d.ControlPoint:d.FreePoint,u=t+h*r,p=i+a*r,f=g(h,a,n+1);o.push(new O(u,p,f,h,a,l))}return o}GenerateSpringLink(){let t={},i=this.nodeLength,n=this._subdivide+1;for(let r=0;r<i;r++){let o=r%n,a=Math.floor(r/n);this.SetSpringLinkToTable(t,this.FindSpring(this._nodes[r],r,o,a,n,this._nodes,[[1,0],[0,1]])),this.SetSpringLinkToTable(t,this.FindSpring(this._nodes[r],r,o,a,n,this._nodes,[[-1,1],[1,1]])),this.SetSpringLinkToTable(t,this.FindSpring(this._nodes[r],r,o,a,n,this._nodes,[[2,0],[0,2]]))}return t}FindSpring(t,i,n,r,o,a,h){let l=[];return h.forEach(u=>{let p=n+u[0],f=r+u[1];if(p<o&&f<o&&p>=0&&f>=0){let k=g(p,f,o),L=a[k],Y=s.dist(t.position,L.position),B={id:M(i,k),restLength:Y,nodes:[t,L]};l.push(B)}}),l}SetSpringLinkToTable(t,i){return i.forEach(n=>{n.id in t||(t[n.id]=n)}),t}},V=C;var D=class{constructor(t){this.previousTimeStamp=0,this._canvas=new b(t),this.inputHandler=new q,this.segments=[],this.lastMousePosition=[0,0],this.inputHandler.RegisterMouseMovement(this._canvas.canvasDom,this.OnMouseUIEvent.bind(this)),this.inputHandler.RegisterButtonEvent(this.OnMouseClickEvent.bind(this)),window.requestAnimationFrame(this.FrameLoop.bind(this))}CreateSpringSegment(t,i,n,r){let o=new P(t,i,n,r);this.segments.push(o)}CreateClothMesh(t,i,n,r){this.springCloth=new V(t,i,n,r),this.springCloth.Update(),console.log(this.springCloth.nodeLength)}FrameLoop(t){let i=(t-this.previousTimeStamp)/1e3;this.time=t/1e3,this.previousTimeStamp=t,this._canvas.Draw(this.springCloth.nodes),this.springCloth.Update(),this.inputHandler.OnUpdate(),this.selectedControlPoint!=null&&this.selectedControlPoint.UpdatePosition(this.lastMousePosition[0],this.lastMousePosition[1]),window.requestAnimationFrame(this.FrameLoop.bind(this))}OnMouseUIEvent(t,i){this.lastMousePosition=t}OnMouseClickEvent(t){if(t==m.Down){let i=this.FindControlPoint(this.lastMousePosition[0],this.lastMousePosition[1]);i!=null&&(this.selectedControlPoint=i)}t==m.Up&&(this.selectedControlPoint=null)}FindControlPoint(t,i){let n=null;return this.springCloth.nodes.forEach(r=>{if(r.type==d.ControlPoint&&s.distance(r.position,s.fromValues(t,i))<10){n=r;return}}),n}},R=D;console.log("Hello world");var Ft="#webgl_canvas",It=new R(Ft);It.CreateClothMesh(200,6,200,200);
//# sourceMappingURL=index.js.map
