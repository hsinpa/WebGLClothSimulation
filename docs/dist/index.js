var d;(function(e){e[e.FreePoint=0]="FreePoint",e[e.ControlPoint=1]="ControlPoint"})(d||(d={}));function m(e,t){let i=document.querySelector(`input[name='${e}']`),n=document.querySelector(`label[name='${e}']`),r=n.innerHTML;i.addEventListener("input",s=>{n.innerHTML=r.replace("{0}",s.target.value),t(parseFloat(s.target.value))}),n.innerHTML=r.replace("{0}",i.value),t(parseFloat(i.value))}function I(e,t,i){return(1-i)*e+i*t}var x=class{constructor(t){this.maxDrawBufferSize=2048,this._canvasDom=document.querySelector(t),this._context=this._canvasDom.getContext("2d"),this.AutoSetCanvasSize(),window.addEventListener("resize",()=>{this.AutoSetCanvasSize()})}get canvasDom(){return this._canvasDom}Draw(t,i){this._context.clearRect(0,0,this._canvasDom.width,this._canvasDom.height);let n=i.length;for(let r=0;r<n;r++){let s=I(225,100,(t-i[r].gridIndexY)/t),a=i[r].type==d.ControlPoint?"59, 50, 255":`255, ${s}, 0`;this.DrawCircle(i[r].position[0],i[r].position[1],7,a)}}DrawCircle(t,i,n,r){this._context.beginPath(),this._context.fillStyle=`rgb(${r})`,this._context.arc(t,i,n,0,2*Math.PI),this._context.fill()}AutoSetCanvasSize(){this.SetCanvasToSceenSize(this._canvasDom.clientWidth,this._canvasDom.clientHeight)}SetCanvasToSceenSize(t,i){this._canvasDom.width=t,this._canvasDom.height=i}},F=x;var L=class{get nodeLength(){return this._nodes.length}get nodes(){return this._nodes}constructor(t,i,n,r){this._segmentNumber=n,this._segmentDistance=r,this._nodes=[];for(let s=0;s<n-1;s++)this.PushNode()}PushNode(){if(this.nodeLength<=0)return;let t=this._nodes[this.nodeLength-1],i=t.position[0],n=t.position[1];return null}PopNode(){if(!(this.nodeLength<=0))return this._segmentNumber--,this._nodes.pop()}Update(){let t=this._nodes.length;for(let i=0;i<t;i++){if(this._nodes[i].isStatic)continue;let n=i>0?this._nodes[i-1]:null}}},T=L;var U=1e-6,S=typeof Float32Array!="undefined"?Float32Array:Array,Q=Math.random;Math.hypot||(Math.hypot=function(){for(var e=0,t=arguments.length;t--;)e+=arguments[t]*arguments[t];return Math.sqrt(e)});function E(){var e=new S(2);return S!=Float32Array&&(e[0]=0,e[1]=0),e}function W(e){var t=new S(2);return t[0]=e[0],t[1]=e[1],t}function J(e,t){var i=new S(2);return i[0]=e,i[1]=t,i}function Z(e,t){return e[0]=t[0],e[1]=t[1],e}function tt(e,t,i){return e[0]=t,e[1]=i,e}function et(e,t,i){return e[0]=t[0]+i[0],e[1]=t[1]+i[1],e}function j(e,t,i){return e[0]=t[0]-i[0],e[1]=t[1]-i[1],e}function A(e,t,i){return e[0]=t[0]*i[0],e[1]=t[1]*i[1],e}function K(e,t,i){return e[0]=t[0]/i[0],e[1]=t[1]/i[1],e}function it(e,t){return e[0]=Math.ceil(t[0]),e[1]=Math.ceil(t[1]),e}function nt(e,t){return e[0]=Math.floor(t[0]),e[1]=Math.floor(t[1]),e}function rt(e,t,i){return e[0]=Math.min(t[0],i[0]),e[1]=Math.min(t[1],i[1]),e}function st(e,t,i){return e[0]=Math.max(t[0],i[0]),e[1]=Math.max(t[1],i[1]),e}function ot(e,t){return e[0]=Math.round(t[0]),e[1]=Math.round(t[1]),e}function at(e,t,i){return e[0]=t[0]*i,e[1]=t[1]*i,e}function lt(e,t,i,n){return e[0]=t[0]+i[0]*n,e[1]=t[1]+i[1]*n,e}function q(e,t){var i=t[0]-e[0],n=t[1]-e[1];return Math.hypot(i,n)}function N(e,t){var i=t[0]-e[0],n=t[1]-e[1];return i*i+n*n}function V(e){var t=e[0],i=e[1];return Math.hypot(t,i)}function O(e){var t=e[0],i=e[1];return t*t+i*i}function ht(e,t){return e[0]=-t[0],e[1]=-t[1],e}function ct(e,t){return e[0]=1/t[0],e[1]=1/t[1],e}function dt(e,t){var i=t[0],n=t[1],r=i*i+n*n;return r>0&&(r=1/Math.sqrt(r)),e[0]=t[0]*r,e[1]=t[1]*r,e}function ut(e,t){return e[0]*t[0]+e[1]*t[1]}function pt(e,t,i){var n=t[0]*i[1]-t[1]*i[0];return e[0]=e[1]=0,e[2]=n,e}function ft(e,t,i,n){var r=t[0],s=t[1];return e[0]=r+n*(i[0]-r),e[1]=s+n*(i[1]-s),e}function gt(e,t){t=t||1;var i=Q()*2*Math.PI;return e[0]=Math.cos(i)*t,e[1]=Math.sin(i)*t,e}function mt(e,t,i){var n=t[0],r=t[1];return e[0]=i[0]*n+i[2]*r,e[1]=i[1]*n+i[3]*r,e}function _t(e,t,i){var n=t[0],r=t[1];return e[0]=i[0]*n+i[2]*r+i[4],e[1]=i[1]*n+i[3]*r+i[5],e}function vt(e,t,i){var n=t[0],r=t[1];return e[0]=i[0]*n+i[3]*r+i[6],e[1]=i[1]*n+i[4]*r+i[7],e}function yt(e,t,i){var n=t[0],r=t[1];return e[0]=i[0]*n+i[4]*r+i[12],e[1]=i[1]*n+i[5]*r+i[13],e}function Mt(e,t,i,n){var r=t[0]-i[0],s=t[1]-i[1],a=Math.sin(n),l=Math.cos(n);return e[0]=r*l-s*a+i[0],e[1]=r*a+s*l+i[1],e}function St(e,t){var i=e[0],n=e[1],r=t[0],s=t[1],a=Math.sqrt(i*i+n*n)*Math.sqrt(r*r+s*s),l=a&&(i*r+n*s)/a;return Math.acos(Math.min(Math.max(l,-1),1))}function Ct(e){return e[0]=0,e[1]=0,e}function wt(e){return"vec2("+e[0]+", "+e[1]+")"}function xt(e,t){return e[0]===t[0]&&e[1]===t[1]}function Lt(e,t){var i=e[0],n=e[1],r=t[0],s=t[1];return Math.abs(i-r)<=U*Math.max(1,Math.abs(i),Math.abs(r))&&Math.abs(n-s)<=U*Math.max(1,Math.abs(n),Math.abs(s))}var kt=V,Dt=j,bt=A,Pt=K,It=q,Ft=N,Tt=O,Ut=function(){var e=E();return function(t,i,n,r,s,a){var l,c;for(i||(i=2),n||(n=0),r?c=Math.min(r*i+n,t.length):c=t.length,l=n;l<c;l+=i)e[0]=t[l],e[1]=t[l+1],s(e,e,a),t[l]=e[0],t[l+1]=e[1];return t}}(),o=Object.freeze({__proto__:null,create:E,clone:W,fromValues:J,copy:Z,set:tt,add:et,subtract:j,multiply:A,divide:K,ceil:it,floor:nt,min:rt,max:st,round:ot,scale:at,scaleAndAdd:lt,distance:q,squaredDistance:N,length:V,squaredLength:O,negate:ht,inverse:ct,normalize:dt,dot:ut,cross:pt,lerp:ft,random:gt,transformMat2:mt,transformMat2d:_t,transformMat3:vt,transformMat4:yt,rotate:Mt,angle:St,zero:Ct,str:wt,exactEquals:xt,equals:Lt,len:kt,sub:Dt,mul:bt,div:Pt,dist:It,sqrDist:Ft,sqrLen:Tt,forEach:Ut});var h=Object.freeze({up:"up",down:"down",left:"left",right:"right"}),_=Object.create({w:h.up,s:h.down,d:h.right,a:h.left,ArrowUp:h.up,ArrowDown:h.down,ArrowRight:h.right,ArrowLeft:h.left});var C=Object.freeze({Up:o.fromValues(0,1),Down:o.fromValues(0,-1),Left:o.fromValues(-1,0),Right:o.fromValues(1,0),Center:o.fromValues(0,0)}),v;(function(e){e[e.Down=0]="Down",e[e.Up=1]="Up",e[e.Click=2]="Click"})(v||(v={}));var Y=class{constructor(){this._buttonState=Object.create({}),this._cacheKeyboardDirection=o.create(),this.isMouseDown=!1}GetButtonState(t){return!1}RegisterButtonEvent(t){this._mouseClickCallback=t;let i=this;window.addEventListener("click",n=>{t(2)}),window.addEventListener("mousedown",n=>{t(0),this.isMouseDown=!0}),window.addEventListener("mouseup",n=>{this.isMouseDown=!1,t(1)})}RegisterMouseMovement(t,i){let n=[0,0],r=[0,0];window.addEventListener("mousemove",s=>{n[0]=s.movementX,n[1]=s.movementY,r[0]=s.offsetX,r[1]=s.offsetY,i(r,n)})}RegisterMovementEvent(t){let i=this;this._keyboardCallback=t,window.addEventListener("keydown",n=>{n.key.toLowerCase()in _&&this.SetKeyboardState(_[n.key],!0)}),window.addEventListener("keyup",n=>{n.key.toLowerCase()in _&&this.SetKeyboardState(_[n.key],!1)})}OnUpdate(){this._cacheKeyboardDirection[0]=0,this._cacheKeyboardDirection[1]=0,this._buttonState.hasOwnProperty(h.left)&&o.add(this._cacheKeyboardDirection,this._cacheKeyboardDirection,C.Left),this._buttonState.hasOwnProperty(h.down)&&o.add(this._cacheKeyboardDirection,this._cacheKeyboardDirection,C.Down),this._buttonState.hasOwnProperty(h.right)&&o.add(this._cacheKeyboardDirection,this._cacheKeyboardDirection,C.Right),this._buttonState.hasOwnProperty(h.up)&&o.add(this._cacheKeyboardDirection,this._cacheKeyboardDirection,C.Up),this.isMouseDown&&this._mouseClickCallback!=null&&this._mouseClickCallback(0),this._keyboardCallback!=null&&this._keyboardCallback(this._cacheKeyboardDirection)}SetKeyboardState(t,i){i?this._buttonState[t]=!0:delete this._buttonState[t]}},z=Y;function y(e,t,i){return e+t*i}function w(e,t){let i=e<t?e:t,n=i==e?t:e;return i+"-"+n}function R(e){let t=[...e];for(let i=t.length-1;i>0;i--){let n=Math.floor(Math.random()*(i+1));[t[i],t[n]]=[t[n],t[i]]}return t}var k=class{constructor(t,i,n,r,s,a){this.isStatic=!1,this._position=o.fromValues(t,i),this._type=a,this._velocity=o.fromValues(0,0),this._acceleration=o.fromValues(0,0),this._index=n,this._gridIndexX=r,this._gridIndexY=s,this.isStatic=a==d.ControlPoint}get type(){return this._type}get position(){return this._position}get index(){return this._index}get gridIndexX(){return this._gridIndexX}get gridIndexY(){return this._gridIndexY}UpdatePosition(t,i){this._position[0]=t,this._position[1]=i}UpdateVelocity(t,i,n){var r=o.create();this._acceleration=this.IntegrateForce(i,n,t),o.scale(r,this._velocity,t.damping),o.sub(this._acceleration,this._acceleration,r),this._externalForce=o.fromValues(0,t.gravity),o.scale(this._externalForce,this._externalForce,t.mass),o.add(this._acceleration,this._externalForce,this._acceleration);let s=1/t.mass;o.scale(this._acceleration,this._acceleration,s),o.scale(this._acceleration,this._acceleration,t.timeStep),o.add(this._velocity,this._velocity,this._acceleration),o.add(this._position,this._position,this._velocity)}IntegrateForce(t,i,n){return o.zero(this._acceleration),[[0,1],[1,0],[0,-1],[-1,0],[1,1],[1,-1],[-1,-1],[-1,1],[0,2],[2,0],[0,-2],[-2,0]].forEach(s=>{let a=this._gridIndexX+s[0],l=this._gridIndexY+s[1];if(a<t&&l<t&&a>=0&&l>=0){let c=y(a,l,t),p=w(this._index,c);if(p in i){let u=i[p],f=Math.floor(u.nodes[0].index)==Math.floor(this.index)?u.nodes[1]:u.nodes[0],M=this.CalSpringForce(this,f,n.k,u.restLength);o.add(this._acceleration,this._acceleration,M)}}}),this._acceleration}CalSpringForce(t,i,n,r){let s=o.fromValues(0,0),a=o.fromValues(0,0),l=o.sub(s,t.position,i.position);o.normalize(a,l),o.scale(a,a,r),o.add(a,i.position,a);let c=o.sub(a,t.position,a);return o.scale(s,c,-n)}},X=k;var D=class{get nodeLength(){return this._nodes.length}get nodes(){return this._nodes}get width(){return this._width}get height(){return this._height}get subdivide(){return this._subdivide}get springMassConfig(){return this._springMassConfig}constructor(t,i,n,r){this._width=t,this._height=t,this._subdivide=i,this._springNatureLength=t/i,this._springMassConfig=this.GetDefaultSpringMassConfig(),this._nodes=this.CreateClothNodes(n,r,i,this._springNatureLength),this._springLinkLookupTable=this.GenerateSpringLink(),console.log(this._springLinkLookupTable)}Update(){let t=R(this._nodes),i=t.length;for(let n=0;n<i;n++)t[n].isStatic||t[n].UpdateVelocity(this._springMassConfig,this._subdivide+1,this._springLinkLookupTable)}SetSpringMassConfig(t){t.k!==void 0&&(this._springMassConfig.k=t.k),t.mass!==void 0&&(this._springMassConfig.mass=t.mass),t.gravity!==void 0&&(this._springMassConfig.gravity=t.gravity),t.damping!==void 0&&(this._springMassConfig.damping=t.damping)}GetDefaultSpringMassConfig(){return{k:7,mass:5,gravity:10,timeStep:.02,damping:30}}CreateClothNodes(t,i,n,r){let s=[];for(let a=0;a<=n;a++)for(let l=0;l<=n;l++){let c=a==0&&l==0||a==0&&l==n?d.ControlPoint:d.FreePoint,p=t+l*r,u=i+a*r,f=y(l,a,n+1);s.push(new X(p,u,f,l,a,c))}return s}GenerateSpringLink(){let t={},i=this.nodeLength,n=this._subdivide+1;for(let r=0;r<i;r++){let s=r%n,a=Math.floor(r/n);this.SetSpringLinkToTable(t,this.FindSpring(this._nodes[r],r,s,a,n,this._nodes,[[1,0],[0,1]])),this.SetSpringLinkToTable(t,this.FindSpring(this._nodes[r],r,s,a,n,this._nodes,[[-1,1],[1,1]])),this.SetSpringLinkToTable(t,this.FindSpring(this._nodes[r],r,s,a,n,this._nodes,[[2,0],[0,2]]))}return t}FindSpring(t,i,n,r,s,a,l){let c=[];return l.forEach(p=>{let u=n+p[0],f=r+p[1];if(u<s&&f<s&&u>=0&&f>=0){let M=y(u,f,s),P=a[M],B=o.dist(t.position,P.position),$={id:w(i,M),restLength:B,nodes:[t,P]};c.push($)}}),c}SetSpringLinkToTable(t,i){return i.forEach(n=>{n.id in t||(t[n.id]=n)}),t}},G=D;var b=class{constructor(t){this.previousTimeStamp=0,this._canvas=new F(t),this.inputHandler=new z,this.segments=[],this.lastMousePosition=[0,0],this.inputHandler.RegisterMouseMovement(this._canvas.canvasDom,this.OnMouseUIEvent.bind(this)),this.inputHandler.RegisterButtonEvent(this.OnMouseClickEvent.bind(this)),window.requestAnimationFrame(this.FrameLoop.bind(this))}get springCloth(){return this._springCloth}CreateSpringSegment(t,i,n,r){let s=new T(t,i,n,r);this.segments.push(s)}CreateClothMesh(t,i,n,r){this._springCloth=new G(t,i,n,r),this._springCloth.Update()}FrameLoop(t){let i=(t-this.previousTimeStamp)/1e3;this.time=t/1e3,this.previousTimeStamp=t,this._canvas.Draw(this._springCloth.subdivide+1,this._springCloth.nodes),this._springCloth.Update(),this.inputHandler.OnUpdate(),this.selectedControlPoint!=null&&this.selectedControlPoint.UpdatePosition(this.lastMousePosition[0],this.lastMousePosition[1]),window.requestAnimationFrame(this.FrameLoop.bind(this))}OnMouseUIEvent(t,i){this.lastMousePosition=t}OnMouseClickEvent(t){if(t==v.Down){let i=this.FindControlPoint(this.lastMousePosition[0],this.lastMousePosition[1]);i!=null&&(this.selectedControlPoint=i)}t==v.Up&&(this.selectedControlPoint=null)}FindControlPoint(t,i){let n=null;return this._springCloth.nodes.forEach(r=>{if(r.type==d.ControlPoint&&o.distance(r.position,o.fromValues(t,i))<10){n=r;return}}),n}},H=b;var Et="#webgl_canvas",g=new H(Et);g.CreateClothMesh(200,6,200,200);var pe=g.springCloth.springMassConfig;m("k",e=>{g.springCloth.SetSpringMassConfig({k:e})});m("mass",e=>{g.springCloth.SetSpringMassConfig({mass:e})});m("gravity",e=>{g.springCloth.SetSpringMassConfig({gravity:e})});m("damping",e=>{g.springCloth.SetSpringMassConfig({damping:e})});
//# sourceMappingURL=index.js.map
